
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>DPKG eats your bandwidth and rots your hard drive -- a plea for incremental packages - My Delusional Dream</title>
  <meta name="author" content="Patrick Wagstrom">

  
  <meta name="description" content="DPKG Eats Your Bandwidth and Rots Your Hard Drive -- a Plea for Incremental Packages Oct 9th, 2007 | var idcomments_acct = ' &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://patrick.wagstrom.net/weblog/2007/10/09/incremental-packages">
  <link href="/weblog/favicon.png" rel="icon">
  <link href="/weblog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/weblog/javascripts/modernizr-2.0.js"></script>
  <script src="/weblog/javascripts/ender.js"></script>
  <script src="/weblog/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/weblog/atom.xml" rel="alternate" title="My Delusional Dream" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/weblog/">My Delusional Dream</a></h1>
  
    <h2>Thoughts of a cautious technocrat</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/weblog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:patrick.wagstrom.net/weblog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/weblog/">Blog</a></li>
  <li><a href="/weblog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">DPKG Eats Your Bandwidth and Rots Your Hard Drive -- a Plea for Incremental Packages</h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-10-09T11:02:00-04:00" pubdate data-updated="true">Oct 9<span>th</span>, 2007</time>
        
        
         | 

<script>
var idcomments_acct = 'de6c2d3e38f6fdb9bf16fa9f1904f35d';
var idcomments_post_id;
var idcomments_post_url;
</script>
<script type="text/javascript" src="http://www.intensedebate.com/js/genericLinkWrapperV2.js"></script>


        
      </p>
    
  </header>


<div class="entry-content"><p>Most modern packaged based operating systems have a facility for easily allowing remote systems to pull down updates.  In the Windows world this is primarily used for distributing bug fixes and security patches through the Windows Update system, although major service packs may introduce new features. In Linux, depending on distribution and configuration, the system may download security and bug fixes, or it may download new versions of software running on the system.  In particular, this is useful for running the development versions of distributions.</p>

<p>On Windows the patches typically come with cryptic names and descriptions and don&#8217;t provide much of a clear description what they do.  A patch is incremental against a known state of the operating system and includes logic to update to the new state.  On Linux the updates come as complete new packages that can be independently installed.  While this removes some of the dependency issues and allows one to install the updates as a complete package, it is often wasteful, especially when the system is going through massive updates as is the case right before major system releases.  For example, here&#8217;s what was presented to me this morning:</p>

<p>Liquid error: ClassNotFound: no lexer for alias &#8216;shell&#8217; found</p>

<p>This update was going to download 295 packages that were around 180MB. It actually claimed to free up some space on my hard drive when it was done.  Luckily, I was on campus so the download actually went pretty fast.  But, really, what was being accomplished?  Was it really necessary to download 180MB of updates for changes that aren&#8217;t even perceptible to me?  I decided to find out.</p>

<p>Before performing the system update I got a list of all the files to be updated and saved a copy of the information.  I also calculated the md5sums of the files and saved the file size for each file in each package to be updated.  Next, I ran the system update and got a list of the files from the new packages, md5sums, and size of the files.  I compared the two sets of information to see what files were actually updated, what files were new, and what files were removed.  Finally, I made a &#8220;dummy&#8221; archive of the updated and new files by copying them into a directory and calculating the size of a tarball of those files. This is a rough estimate for the size of a incremental package.</p>

<p>The total size of all packages downloaded was 160.33MB, when unpacked these files took up 452.37MB, versus 476.14MB before the update; about what apt indicated I would save. However, this is not the complete story. apt caches the previously downloaded files in /var/cache/apt/archive.  In reality, my drive now has an extra 136.61MB of data stored on it because of the saved packages.  Although, it is safe to delete those packages in most cases.</p>

<p>While drive storage is a concern, it&#8217;s actually pretty minor.  Drive space is really cheap and a couple of hundred megs here or there don&#8217;t make much of a difference.  However, transferring all that data is what consumes my time.  Surely it&#8217;s not the case that everything in each one of those packages was new.  To examine this, I plotted the number of files in the package versus the number of files the incremental update modified.  The correlation is 0.43, which isneither high nor low &#8211; some correlation is to be expected because the number of modified files can never go higher than the number of files in the package.  The fact that the correlation isn&#8217;t higher means that many packages are sending files that don&#8217;t need to be updated.</p>

<p><img src="/weblog/media/2007/09/dpkgTotalFilesVsModifiedFiles.png" alt="total files vs modified files plot" /></p>

<p>For many people, correlations and log-log plots may not be the most helpful in understanding what is going on, so lets visualize this another way.  Below is a histogram showing how many packages had what percentage of files modified.  It&#8217;s pretty clear that most packages had only a small fraction of files modified.  In many cases, 80% of the files transmitted had no changes at all.  Multiply that across multiple incremental updates, and that&#8217;s a lot of wasted bandwidth and
disk space.</p>

<p><img src="/weblog/media/2007/09/dpkgPercentageModifiedHistogram.png" alt="histogram of percentage of files modified" /></p>

<p>After seeing the histogram, some folks will argue that updates are more likely to larger files, so we&#8217;re not really wasting as much bandwidth.  After all, looking at many packages, such as bash, the largest files are often binaries
and libraries &#8211; those that are most likely to be changed in the incremental updates.  To understand this, I wrote a script to create dummy incremental packages.  Basically, I copied all of the files that were modified into a new directory, created a tarball of the files, and examined the size of the executable.  This is only a rough estimate of the size as I did not create a dpkg, so it&#8217;s missing the associated overhead there and estimates of bandwidth saved may be a bit optimistic.</p>

<p>The total size of all the dummy packages was 76.35MB, a savings of almost 84MB, or 53% of the original size.  It&#8217;s like a double speedup in your download speeds.  In addition, we save a bit a disk space, and the bandwidth requirements for update sites are diminished significantly.  Not all updates compressed the same amount, as shown below.</p>

<p><img src="/weblog/media/2007/09/dpkgPercentageHistogram.png" alt="histogram of percentage of incremental package size" /></p>

<p>About a sixth of the smaller packages would be under 10% of the downloaded package size, while another sixth of the packages would have little change in their size.  The rest of the packages have a pretty uniform distribution.</p>

<p>What I&#8217;m proposing here is a form of incremental packaging &#8211; it&#8217;s apparently one of the key features of the <a href="http://www.foresightlinux.org/">Foresight Linux</a>.  Their system is built on top a pretty cool packaging system called conary, but I don&#8217;t think that <a href="http://www.ubuntu.org/">Ubuntu</a> will adopt it any time soon.  <a href="http://www.debian.org/">Debian</a> folks will consider it to be some kind of conspiracy and either choose not to implement a change, or it will take them 10 years to do it.</p>

<p>There may be a way to accomplish this with the only slight modifications to the current dpkg infrastructure by taking some hints from digital video compression. In video compression, the entire frame is not encoded from one frame to another, rather only the incremental changes are stored.  Once in a while, depending on configuration usually from every 0.5 - 3 seconds a key frame comes along.  This key frame is a complete re-encoding of the image and the next frame is based off the changes from the key frame.  The process repeats until the next key frame comes along.</p>

<p>This results in some great compression especially when the changes in a scene are small, however can take a hit when changes are significant.  That&#8217;s why if you look closely at HDTV signals in action films you can see some little blocks.  Basically the encoding is basing it off a key frame and there is a lot of data to re-encode at a low bitrate.  I&#8217;m simplifying here, but hopefully you get the picture.</p>

<p>As far as dpkg goes, a similar situation could be created.  Periodically package managers could roll a new &#8220;key frame&#8221; version of a package, such as when a new official release of a package is made.  When security updates, or bug patches are made, a incremental package would be generated with only the changes from the &#8220;key frame&#8221; &#8211; this differs from digital video in that video works from the last incremental frame.  The reason to differ from the &#8220;key frame&#8221; is because we can&#8217;t assume that everyone has obtained the entire stream of packages, like we usually can with video.  The information on the &#8220;key frame&#8221; package name can be stored in the package information and it could be automatically downloaded from the same source.</p>

<p>Here&#8217;s where it could get interesting.  When first installing a package, you&#8217;ll end up taking a bit of a hit if you&#8217;re not installing a &#8220;key frame&#8221; because you&#8217;ll need both the incremental package and the key frame.  However, when upgrading you&#8217;ll save some nice bandwidth.</p>

<p>The astute reader may note that this requires you to keep a copy of the &#8220;key frame&#8221; package around, which makes some of the savings a little moot.  There are a couple of different ways to address this.  One is to create an archive cache on the system.  When an incremental package makes modifications to a file from a &#8220;key frame&#8221; package, the original &#8220;key frame&#8221; version would be saved and probably compressed somewhere. Then when upgrading to a new incremental package,
dpkg would roll back the last package and apply the new one.  The  roll back configuration means we won&#8217;t have to save files from an incremental package that another incremental package modified.  Another option is to keep a listing of the files changed somewhere and download the &#8220;key frame&#8221; package if there are enough changes that the incremental package can&#8217;t deal with it.</p>

<p>As far as distributing the operating system on physical media, this change shouldn&#8217;t make any difference &#8211; all of the packages on the CD/DVD would be &#8220;key frames&#8221; that work independently.  When upgrading and applying security fixes we&#8217;d save a lot of bandwidth.  However, a down side is that such a technology is not very well suited for locations with very low bandwidth as an incremental package without a &#8220;key frame&#8221; is rather useless.  I haven&#8217;t quite figured out how this could work with platforms like the OLPC, but hopefully it&#8217;s a start.</p>
</div>


<script>
var idcomments_acct = 'de6c2d3e38f6fdb9bf16fa9f1904f35d';
var idcomments_post_id;
var idcomments_post_url;
</script>
<span id="IDCommentsPostTitle" style="display:none"></span>
<script type='text/javascript' src='http://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>




  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Patrick Wagstrom</span></span>

      








  


<time datetime="2007-10-09T11:02:00-04:00" pubdate data-updated="true">Oct 9<span>th</span>, 2007</time>
      

<span class="categories">
  
    <a class='category' href='/weblog/blog/categories/linux/'>linux</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://patrick.wagstrom.net/weblog/2007/10/09/incremental-packages/" data-via="pridkett" data-counturl="http://patrick.wagstrom.net/weblog/2007/10/09/incremental-packages/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/weblog/2007/09/27/grandr-public-git-repo/" title="Previous Post: Grandr Public Git Repository now Open">&laquo; Grandr Public Git Repository now Open</a>
      
      
        <a class="basic-alignment right" href="/weblog/2007/10/20/wplug-mythtv-talk/" title="Next Post: Slides from WPLUG MythTV Talk">Slides from WPLUG MythTV Talk &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/weblog/2012/05/10/static-bloggin/">Static Bloggin</a>
      </li>
    
      <li class="post">
        <a href="/weblog/2012/01/28/i-am-not-a-climatologist-and-neither-are-most-of-these-people/">I am not a climatologist, and neither are most of these people</a>
      </li>
    
      <li class="post">
        <a href="/weblog/2012/01/10/looking-for-summer-interns-in-the-software-technology-group-at-ibm-tj-watson-research-center/">Looking for Summer Interns in the Software Technology Group at IBM TJ Watson Research Center</a>
      </li>
    
      <li class="post">
        <a href="/weblog/2012/01/03/a-review-of-2011-personal-development-goals/">A Review of 2011 Personal Development Goals</a>
      </li>
    
      <li class="post">
        <a href="/weblog/2012/01/03/open-source-and-technology-predictions-for-2012/">Open Source and Technology Predictions for 2012</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/pridkett">@pridkett</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pridkett',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/weblog/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("pridkett", 4, false);
    });
  </script>
  <script src="/weblog/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/pridkett" class="twitter-follow-button" data-show-count="false">Follow @pridkett</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/102672530623465237388?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Patrick Wagstrom -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
