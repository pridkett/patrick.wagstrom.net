LPD for fun and MP3 playing

<!-- Date: 2003-05-23 15:30 -->
<p>
<h4>Background</h4>
<p>
Most true Unix geeks will recognize just how nice LPD is as a distributed queueing mechanism for managing all jobs sent to the printer.  It has a beautiful simplicity to it, and some mean power to go along with it.  It's a difficult beast to tame, but once you understand it, everything will start coming out exactly like you want it.
</p>
<p>
But, what most people don't realize is that LPD can be used for other things too.  In fact, it can be viewed as a general queueing mechanism with a few added bells and whistles for printers.  So let's examine a more interesting use of LPD, an engine for distributed spooling of MP3s.
</p>

<h4>Motivation</h4>
<p>
The main thing that got me started on this quest was seeing these two pictures (<a href="http://www.benzedrine.cx/c2k3/DSC00550-medium.jpg">one</a>, <a href="http://www.benzedrine.cx/c2k3/DSC00567-medium.jpg">two</a>) from the <a href="http://www.benzedrine.cx/c2k3/">c2k3 openBSD hackathon</a> I saw that obviously someone else had figured out how to do it.  I sure as heck could also.
</p>

<h4>Initial Assessment</h4>
<p>
The first stop on my quest was examine the all-knowing seer of the Internet, <a href="http://www.google.com/">google</a>.  That returned a <a href="http://www.update.uu.se/~peterl/html/sub_hobbies/comp/hacks/mp3skrivare.html">wonderful page in Swedish</a> about how to do this very task.  Unfortunately, my swedish sucks, but thankfully the scripts were written in bash, and the other big thing was just a printcap file.
</p>

<h4>Creating a Printcap Entry</h4>
<p>
The first thing that you need to do is to create an entry in your printcap file for your shiny new mp3 printer.  On most systems this file is <b>/etc/printcap</b> on my <a href="http://www.redhat.com/">redhat</a> 7.3 system (no sound card on the openBSD firewall) it is <b>/etc/printcap.local</b>.  You'll want to paste the following snipped of code in there:
</p>
<pre>
mp3:\
        :lp=/dev/null:\
        :sd=/var/spool/lpd/audio:\
        :if=/usr/local/bin/audiofilter:\
        :af=/var/log/audio-acct:\
        :lf=/var/log/audio-errs:\
        :sh
</pre>
<p>
Now we'll walk through the entry line by line.  I'll ignore the \ at the end of almost every line, that just tells lpd to keep reading because there is more to come.  The last line doesn't need the \ obviously.
<ul>
<li>1: <b>mp3:</b> - the name of your mp3 printer.  In this case, just mp3</li>
<li>2: <b>:lp=/dev/null:</b> - we're not hooking this up to a physical device in the normal sense</li>
<li>3: <b>:if=/usr/local/bin/audiofilter:</b> - this is the input filter.  I'll show how to create it later.</li>
<li>4: <b>:af=/var/log/audio-acct:</b> - this is the accounting file.  You could do some fun stuff with this to monitor who uses the queue the most and what not.</li>
<li>5: <b>:lf=/var/log/audio-errs:</b> - this is the file that errors will be logged to.  Well, some errors; not all errors will end up here.</li>
<li>6: <b>:sh</b> - tells it to supress any header information that would normally be sent.  This is important or you may get junk before every file which causes audiofilter to fail.</li>
</ul>
</p>

<h4>An Audio Input Filter</h4>
<p>
The key to the whole system is that all of the processing is done by input filter.  On some platforms this may cause it say that the printing has stalled while a song is playing, but that's not a big deal.  There is no output from the input filter, and thus nothing is done after this.  You'll want to put the following piece of code on your system as <b>/usr/local/bin/audiofilter</b>:
</p>
<pre>
#!/bin/bash
#
# This script was originally made by Teddy Hogeborn.
# Small alterations was made by:
#   Peter Lundqvist
#   Patrick Wagstrom
#
# This is a "printer filter" for playing audio files

for arg in "$@"; do
  case "$arg" in
    -d*) dir="${arg#-d}" ;;
    -e*) basefile="${arg#-e}" ;;
    -f*.*) ext="${arg##*.}" ;;
  esac
done

mp3player="mpg123 -q -o oss";
modplayer="mikmod --quiet --playmode 0 --noloops --norc"
oggplayer="ogg123 --device=oss --quiet"
file="${dir}/${basefile}"
type="$(file "${file}"| sed -e 's/^[^:]*: *//')"

case "$type" in
  MP3*)
    $mp3player -
    ;;
  Ogg*Vorbis*)
    $oggplayer -
    ;;
  RIFF*\ WAVE\ audio*)
    /usr/bin/play --type=wav --silent /dev/stdin
    ;;
  *Extended\ Module\ sound\ data*|*Protracker\ module\ sound\ data*)
    $modplayer $file
    ;;
  data|*audio*)
    if ogginfo "$file" 2>/dev/null | grep --quiet -e '^header_integrity=pass' >/dev/null; then
      $oggplayer -
    elif mp3info -x "$file" 2>/dev/null| grep --quiet -e '^File:' > /dev/null; then
      $mp3player -


    else
      play --type=auto --silent "$file" || play --type="$ext" --silent "$file"
    fi
    ;;
  *) echo "$type" >&amp;2 ;;
esac
</pre>
<p>
Here is the basic overview of what the system does.  The beginning of the code parses the arguments that are passed to the print filter from the printer.  It then stores them in a couple of variables.  It then has some declarations for where you can find your mp3, ogg, and mod player.  You should note, this system is also extensible with little difficulty.
</p>
<p>
After this the format of the file is obtained by running the program <b>file</b> on it.  This nifty little tool that most people overlook will examine a file and usually can provide a pretty good guess about what sort of file it is.  It's great at identifying files with incorrect extensions where you'd otherwise never be aware of it.
</p>
<p>
Finally, the options for the type of the file are parsed in a case statement and then the appropriate player is called.  In all cases, the input stream is fed over standard input.  The applications should be quiet, lpd usually assumes that if there is any output from a filter that something has gone wrong.
</p>
<p>
You may need to modify this script some.  The main reason is that not all version of the <b>file</b> utility return the same strings.  Some return "MPEG 2 layer 3 audio" for an MP3 file, while mine returns "MP3, 128 kBits, 44.1 kHz, Stereo" or something similar.  Thus, you may need to modify the values for the case statement some to get the system to your liking.
</p>

<h4>Accessing the Sound Card</h4>
<p>
Up to this point we haven't done anything that could be considered a big security risk.  This point is minor, but you need to give the account for your printer access to the sound card so it can play the music.  This is done by giving it right to write the <b>/dev/audio</b> and <b>/dev/dsp</b>.  If you're lazy you could just do a <b>chmod a+rw /dev/audio /dev/dsp</b>, but that allows all sorts of people to do things with your sound card.  You're better off putting all people with rights to the sound card in a group and then also putting the lp account in the group too.  For instance, creating a group called <b>snduser</b> with all the accounts that have access to the card in it, and also the lp account.  The doing <b>chgrp snduser /dev/audio /dev/dsp</b> and <b>chmod g+rw /dev/audio /dev/dsp</b> should take care of it for you.
</p>
<p>
While you're creating files, you'll need to create those two accounting files that I mentioned in the <b>/etc/printcap</b> entry.  You can do this by running the following commands:
</p>
<pre>
touch /var/log/audio-acct
touch /var/log/audio-errs
chown lp /var/log/audio-acct
chown lp /var/log/audio-errs
</pre>

<h4>Enjoying The Music</h4>
<p>
The final step is to enjoy the music.  Provided that you've done everything right so far you should be able to execute <b>lpr -Pmp3 [your music file]</b> and shortly afterwards it should start playing for your speakers.
</p>
<p>
One of the really nice things about this is that you can use <b>lpq</b> to see what songs are on the queue and <b>lprm</b> to remove a song from the queue.  Here is an example (yes, I own the albums):
</p>
<pre>
[/u2/mp3]
[patrick@dreams] <b>lpr -Pmp3 Wally\ Pleasant\ -\ Alternateen.mp3</b>
[/u2/mp3]
[patrick@dreams] <b>lpr -Pmp3 Wally\ Pleasant\ -\ Bigger\ Than\ Elvis\ -\ Wally\ World.mp3</b>
[/u2/mp3]
[patrick@dreams] <b>lpr -Pmp3 Wally\ Pleasant\ -\ In\ Love\ with\ a\ Geek.mp3</b>
[/u2/mp3]
[patrick@dreams] <b>lpr -Pmp3 Wally\ Pleasant\ -\ It\'s\ a\ Beautiful\ Day.mp3</b>
[/u2/mp3]
[patrick@dreams] <b>lpq -Pmp3</b>
Printer: mp3@dreams
 Queue: 4 printable jobs
 Server: pid 7043 active
 Unspooler: pid 7044 active
 Status: waiting for subserver to exit at 16:22:55.342
 Rank   Owner/ID                  Class Job Files                 Size Time
active patrick@dreams+42            A    42 Wally Pleasant - A 2727348 16:22:38
2      patrick@dreams+50            A    50 Wally Pleasant - B 2679246 16:22:42
3      patrick@dreams+52            A    52 Wally Pleasant - I 3266864 16:22:49
4      patrick@dreams+54            A    54 Wally Pleasant - I 3469897 16:22:55
</pre>

<h4>It's not working!</h4>
<p>
Contrary to what you may be thinking, the first step if this is not working is not to e-mail me about your system configuration.  I probably won't be much help.  The first step is to go into the spooling directory, in this case <b>/var/spool/lpd/audio</b> and see what's lying in there.  The file that you'll want to look at is <b>status.pr</b>.  This provides the status of your printer.  If there was any output from the script, it will be saved in there.  Look around in there and use that for a debugging point.
</p>

<h4>Questions/Follow-up Ideas</h4>
<p>
If you've got a question about this article and think it's something that should be addressed more, let me know.  Also, if you've got an idea for a followup, I'd like to hear those also.   I'm always looking for interesting new hacks to try out and experiment with.
</p>
</p>
