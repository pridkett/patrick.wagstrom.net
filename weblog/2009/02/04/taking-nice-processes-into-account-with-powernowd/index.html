
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Taking "nice" Processes Into Account With Powernowd - My Delusional Dream</title>
  <meta name="author" content="Patrick Wagstrom">

  
  <meta name="description" content="Taking "Nice" Processes Into Account With Powernowd Feb 4th, 2009 | var idcomments_acct = 'de6c2d3e38f6fdb9bf16fa9f1904f35d';
var idcomments_post_id &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://patrick.wagstrom.net/weblog/2009/02/04/taking-nice-processes-into-account-with-powernowd">
  <link href="/weblog/favicon.png" rel="icon">
  <link href="/weblog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/weblog/javascripts/modernizr-2.0.js"></script>
  <script src="/weblog/javascripts/ender.js"></script>
  <script src="/weblog/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/weblog/atom.xml" rel="alternate" title="My Delusional Dream" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/weblog/">My Delusional Dream</a></h1>
  
    <h2>Thoughts of a cautious technocrat</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/weblog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:patrick.wagstrom.net/weblog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/weblog/">Blog</a></li>
  <li><a href="/weblog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Taking "Nice" Processes Into Account With Powernowd</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-04T12:31:00-05:00" pubdate data-updated="true">Feb 4<span>th</span>, 2009</time>
        
        
         | 

<script>
var idcomments_acct = 'de6c2d3e38f6fdb9bf16fa9f1904f35d';
var idcomments_post_id;
var idcomments_post_url;
</script>
<script type="text/javascript" src="http://www.intensedebate.com/js/genericLinkWrapperV2.js"></script>


        
      </p>
    
  </header>


<div class="entry-content"><p>Almost every modern CPU supports the ability to dynamically change its clock frequency &#8211; typically done to save power when there are lesser requirements placed on the system.  While the benefits for a laptop are obvious, more battery life and less heat, they may be a bit harder to understand for a desktop machine.  One application, however, where you should be particularly aware of CPU frequency scaling is with media center boxes.  The less often the CPU needs to speed up, the less heat, the quieter the fan, and the lower your power bill.  On my system, the differences can be pretty dramatic, with the CPU taking an extra 20-30 watts when running at full speed versus slower rates.</p>

<p>Within Linux, there are numerous ways that the CPU frequency is controlled, for example with <a href="http://deater.net/john/powernowd.html">powernowd</a> or the kernel level <a href="http://www.linuxinsight.com/ols2006_the_ondemand_governor.html">ondemand governor</a>, which is the default with most Linux distributions.  One of the aspects of these technologies is that when the system is heavily loaded with processes with high &#8220;nice&#8221; levels, the CPU will not speed up.  For most cases this is fine, but when running a MythTV box, it may be desirable to allow nice processes to increase the CPU speed &#8211; particularly as these nice processes may be things like transcoding or commercial cutting jobs.  Allowing the CPU to ramp up is particular helpful for evenings where many programs are recorded.  On a Monday night where my MythTV box grabs five HD programs, without allowing the CPU to speed up, it can take over a day to commercial flag and trascode everything.  When the CPU can speed up this time drops to about 8 hours.</p>

<p>Under Ubuntu the default configuration is to use the &#8220;ondemand&#8221; governor, which means there is no daemon running and the CPU will scale with demand and load.  However, there is nasty line buried in the /etc/init.d/powernowd startup script:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    use_ondemand<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$OPTIONS&quot;</span> !<span class="o">=</span> <span class="s2">&quot;-q&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">            return </span>1
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'><span class="k">        </span><span class="nv">status</span><span class="o">=</span>1  <span class="c"># return error, if no cpu dirs are found</span>
</span><span class='line'>        <span class="k">for </span>x in /sys/devices/system/cpu/cpu<span class="o">[</span>0-9<span class="o">]</span>*/; <span class="k">do</span>
</span><span class='line'><span class="k">            if</span> <span class="o">[</span> ! -d <span class="nv">$x</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> ! -f <span class="nv">$x</span><span class="s2">&quot;cpufreq/scaling_governor&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">                continue</span>
</span><span class='line'><span class="k">            fi</span>
</span><span class='line'><span class="k">            </span><span class="nb">echo</span> -n ondemand &gt; <span class="nv">$x</span><span class="s2">&quot;cpufreq/scaling_governor&quot;</span>
</span><span class='line'>            <span class="nv">status</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">[</span> <span class="nv">$status</span> !<span class="o">=</span> 0 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">            return</span> <span class="nv">$status</span>
</span><span class='line'>            <span class="k">fi</span>
</span><span class='line'>            <span class="c"># The default behaviour of powernowd is to ignore nice load:</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$x</span><span class="s2">&quot;cpufreq/ondemand/ignore_nice_load&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">                </span><span class="nb">echo</span> -n 1 &gt; <span class="nv">$x</span><span class="s2">&quot;cpufreq/ondemand/ignore_nice_load&quot;</span>
</span><span class='line'>            <span class="k">fi</span>
</span><span class='line'><span class="k">        done</span>
</span><span class='line'><span class="k">        return</span> <span class="nv">$status</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Line 108 is the culprit of our problems.  By echoing the string <code>1</code> to <code>/sys/devices/system/cpu/cpu[0-9]*/cpufreq/ondemand/ignore_nice_load</code>, the ondemand governor will not take into account nice loads.  Under previous versions of <a href="http://www.ubuntu.com/">Ubuntu</a>, or when you&#8217;re not using ondemand and actually need powernowd to run, this change was easily done <a href="/weblog/weblog/2006/01/13/faster-transcoding/">altering some settings in /etc/defaults</a> as I detailed 3 years ago.  However, now you need to hack the script yourself.  The simplest way is just to change the <code>1</code> to a <code>0</code> on line 102 of <code>/etc/init.d/powernowd</code>, giving the following line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo -n 0 > $x"cpufreq/ondemand/ignore_nice_load"</span></code></pre></td></tr></table></div></figure>


<p>Change this setting, then you can either reboot, or run <code>/etc/init.d/powernowd restart</code> as root.  If you watch your CPU speed (check out /proc/cpuinfo), you should notice that nice processes now speed up the CPU.</p>
</div>


<script>
var idcomments_acct = 'de6c2d3e38f6fdb9bf16fa9f1904f35d';
var idcomments_post_id;
var idcomments_post_url;
</script>
<span id="IDCommentsPostTitle" style="display:none"></span>
<script type='text/javascript' src='http://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>




  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Patrick Wagstrom</span></span>

      








  


<time datetime="2009-02-04T12:31:00-05:00" pubdate data-updated="true">Feb 4<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/weblog/blog/categories/linux/'>linux</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://patrick.wagstrom.net/weblog/2009/02/04/taking-nice-processes-into-account-with-powernowd/" data-via="pridkett" data-counturl="http://patrick.wagstrom.net/weblog/2009/02/04/taking-nice-processes-into-account-with-powernowd/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/weblog/2009/02/02/delay-the-dtv-transition-again/" title="Previous Post: Delay the DTV Transition Again?">&laquo; Delay the DTV Transition Again?</a>
      
      
        <a class="basic-alignment right" href="/weblog/2009/02/05/confusion-abounds-dtv-transition-delayed-until-june-12-or-is-it/" title="Next Post: Confusion Abounds!  DTV Transition Delayed Until June 12.  Or is it?">Confusion Abounds!  DTV Transition Delayed Until June 12.  Or is it? &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/weblog/2012/05/10/static-bloggin/">Static Bloggin</a>
      </li>
    
      <li class="post">
        <a href="/weblog/2012/01/28/i-am-not-a-climatologist-and-neither-are-most-of-these-people/">I am not a climatologist, and neither are most of these people</a>
      </li>
    
      <li class="post">
        <a href="/weblog/2012/01/10/looking-for-summer-interns-in-the-software-technology-group-at-ibm-tj-watson-research-center/">Looking for Summer Interns in the Software Technology Group at IBM TJ Watson Research Center</a>
      </li>
    
      <li class="post">
        <a href="/weblog/2012/01/03/a-review-of-2011-personal-development-goals/">A Review of 2011 Personal Development Goals</a>
      </li>
    
      <li class="post">
        <a href="/weblog/2012/01/03/open-source-and-technology-predictions-for-2012/">Open Source and Technology Predictions for 2012</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/pridkett">@pridkett</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pridkett',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/weblog/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("pridkett", 4, false);
    });
  </script>
  <script src="/weblog/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/pridkett" class="twitter-follow-button" data-show-count="false">Follow @pridkett</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/102672530623465237388?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Patrick Wagstrom -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
