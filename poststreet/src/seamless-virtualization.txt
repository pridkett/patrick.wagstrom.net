Seamless Windows Virtualization
<!-- Date: 2008-04-27 15:12 -->

<p>
Virtualization of desktop operating systems is pretty
commonplace for users of Linux and Mac OS.  Initial implementations of
desktop virtualization, such as VMWare 1.0, had the guest operating
system running in complete isolation.  Interaction was done through a
custom application or network applications.  There was no
support for sharing files, sharing a clipboard, or merging the
windowing environments.
</p>
<p>
Since then, virtualization has come a very long way.  With VMWare and
a supported guest operating system, the clipboards are the same, the
mouse isn't locked to a window, and files are easily shared between
operating system.  Sadly, merging of windowing environments still
isn't quite there.  Your guest desktop still runs completely in a
window on the host.  VMWare has a new technique available in Fusion,
their Mac product, called Unity that allows this.  Parallels supports
a similar feature called Cohesion, and I've been told that VirtualBox
supports this feature too.  This is a fine feature, if you have one of
the newer products that supports this.  If you're like me and still
using VMWare Player, an older version of VMWare workstation, or
connecting to remote windows systems with remote desktop, this isn't a
native feature.  Luckily, it's a pretty easy hack to get seamless
windows.
</p>
<p>
Enter <a href="http://www.cendio.com/seamlessrdp/">SeamlessRDP</a>
from <a href="http://www.cendio.com/">Cendio</a>.  This little program
extends the standard RDP system a little bit to provide for complete
desktop integration when
using <a href="http://www.rdesktop.org/">rdesktop</a>.  It works in
conjunction with <my:command>rdesktop</my:command>, so other tools
such as <my:command>tsclient</my:command> won't work.  Unfortunately,
the directions for this aren't always the most clear, and they didn't
work with my instance of VMWare, so here's how I managed to do it.
These instructions are specific to Windows XP Pro.
</p>
<ol>
<li>
  First, go and download <a href="http://www.cendio.com/files/thinlinc/seamlessrdp/seamlessrdp.zip">seamlessrdp.zip</a> and extract it to something
  like <my:pathname>c:\windows</my:pathname>. There should be three
  files in there, the one that we really care about
  is <my:program>seamlessrdpshell.exe</my:program>.</li>
  <li>Make sure that that you allow remote connections, go to control
  panel->system->remote and check "Allow users to remotely connect to
  this computer".  At this point, you'll be able to test a remote
  desktop connection to your virtual machine through the
  command <my:command>rdesktop REMOTESERVERIP</my:command>.  You'll
  notice that you're still running everything in still running a single
  window because we haven't invoked <my:program>seamlessrdpshell</my:program> yet.
  <my:captionimage src="/resources/images/blog/seamlessrdp-systemProperties.png" width="419" height="486" alt="System properties to enable remote desktop">Enable "Allow users to remotely connect to this computer"</my:captionimage>
</li>
<li>
  Enable welcome screen and fast user switching -- this is something
  that you normally don't see in enterprise deployments, but
  apparently it is necessary for this.  I can't figure out how to make
  it work without this.  Go to control panel->user accounts and check
  both of the options.
  <my:captionimage src="/resources/images/blog/seamlessrdp-userAccountSettings.png" width="730" height="530" alt="Check both options on the user account settings screen">Make sure both options are checked</my:captionimage>
<li>
  Tell Explorer to not draw the desktop -- the reason is pretty
  simple, if explorer drew the desktop the window would still be full
  screen.  We can change this by creating a new registry
  in <my:pathname>My Computer\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer</my:pathname>.
  Call it NoDesktop, and make it a DWORD with a value of 1.  This will
  keep explorer from drawing the desktop.
  <my:captionimage src="/resources/images/blog/seamlessrdp-regedit.png" width="789" height="517" alt="Registry settings">Create a new DWORD registry entry called NoDesktop with a value of 1</my:captionimage>
</li>
<li>
  Here comes some of the stranger stuff, that you may not need to do, but I found necessary for my system and it wasn't properly documented anywhere.  In most cases, you can specify an application to run with the -s option to <my:program>rdesktop</my:program>, unfortunately, this doesn't work on my system.  Instead, we'll need to use  a rarely used program that allows you to set system level policies.  Go to start->run and enter <my:program>gpedit.msc</my:program>.  Select User Configuration->Administrative Templates->Windows Components->Terminal Services.
  <my:captionimage src="/resources/images/blog/seamlessrdp-gpedit.msc.png" width="922" height="572" alt="gpedit.msc program screen">Run <my:program>gpedit.msc</my:program> and navigate down to User Configuration->Administrative Templates->Windows Components->Terminal Services.</my:captionimage>
  Now, the crutch that we'll use to select "Start a program on
  connection".  Double click and check the Enabled box and enter
  in <my:command>c:\windows\seamlessrdpshell.exe
  c:\windows\explorer.exe</my:command>.  Click apply and then exit.
  <my:captionimage src="/resources/images/blog/seamlessrdp-gpedit.mscProp.png" width="405" height="455" alt="update the program to execute on connection">Enter <my:command>c:\windows\seamlessrdpshell.exe c:\windows\explorer.exe</my:command> for the command to run on connection.</my:captionimage>
</li>
<li>
  At this point, if you log out, everything should work, but the
  graphics may be a bit funny.  In my experience I've found that there
  are two more small changes necessary before everything works nicely.
  First, make sure you're using the Windows XP appearance and not the
  classic appearance.  Second, uncheck the option to keep the task bar
  on top, as this will cause issues when maximizing windows
  applications.  And finally, you can't have another panel on the
  bottom or the start bar will try to redraw itself poorly, over and over.
  <my:captionimage src="/resources/images/blog/seamlessrdp-startMenuProperties.png" width="404" height="455" alt="uncheck always on top">Uncheck the option to keep the taskbar on top</my:captionimage>
</li>
<li>
  Now, all you need to do is make sure you're logged out of the
  virtual machine, and execute the following
  command: <my:command>rdesktop -r sound:local -A REMOTESERVERIP:3389
  -u "WINDOWSUSER" -p "WINDOWSPASSWORD"</my:command>.  If everything
  goes well you should get a nice little windows start menu at the
  bottom of the screen and your windows apps will run seamlessly.
  It's not 100% perfect, but any sort of virtualization, especially a
  hack like this, never is.  In particular, sloppy focus causes
  windows programs to jump to the front.  But other things work great,
  like a shared clipboard and sound.  It makes working in both worlds
  lots easier.
</li>
  <my:captionimage src="/resources/images/blog/seamlessrdp-fulldesktop.png" width="700" height="525" alt="the final product">The final product</my:captionimage>
</ol>

<my:tags>
  <my:tag>virtualization</my:tag>
  <my:tag>vmware</my:tag>
  <my:tag>remote desktop</my:tag>
  <my:tag>seamless</my:tag>
  <my:tag>virtualbox</my:tag>
  <my:tag>linux</my:tag>
  <my:tag>windows</my:tag>
  <my:tag>desktop</my:tag>
</my:tags>
